<html data-livestyle-extension="available">

<head>
    <title>任務回報-水利署防救災決策輔助系統</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="./public/javascript/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="./public/views/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="./public/views/font-awesome/css/icon-font.min.css">
    <link rel="stylesheet" type="text/css" href="./public/views/vendor/animate/animate.css">
    <link rel="stylesheet" type="text/css" href="./public/views/vendor/css-hamburgers/hamburgers.min.css">
    <link rel="stylesheet" type="text/css" href="./public/views/vendor/animsition/css/animsition.min.css">
    <link rel="stylesheet" type="text/css" href="./public/views/vendor/select2/select2.min.css">
    <link rel="stylesheet" type="text/css" href="./public/views/vendor/daterangepicker/daterangepicker.css">
    <link rel="stylesheet" type="text/css" href="./public/views/css/regist/util.css">
    <link rel="stylesheet" type="text/css" href="./public/views/css/regist/main.css">
    <!--<link rel="stylesheet" type="text/css" href="./static/css/style.css">-->
    <script type="text/javascript" async="" src="https://www.google-analytics.com/analytics.js"></script>
    <script type="text/javascript" async="" src="https://www.google-analytics.com/analytics.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js">
        charset = "utf-8"
    </script>
    <script src="./public/views/vendor/animsition/js/animsition.min.js" type="text/javascript"></script>
    <script src="./public/views/vendor/bootstrap/js/popper.js" type="text/javascript"></script>
    <script src="./public/javascript/bootstrap/js/bootstrap.min.js">
        charset = "utf-8"
    </script>
    <script src="./public/views/vendor/select2/select2.min.js" type="text/javascript"></script>
    <script src="./public/views/vendor/daterangepicker/moment.min.js" type="text/javascript"></script>
    <script src="./public/views/vendor/daterangepicker/daterangepicker.js" type="text/javascript"></script>
    <script src="./public/views/vendor/countdowntime/countdowntime.js" type="text/javascript"></script>
    <script src="./public/javascript/reportpage.js" type="text/javascript"></script>
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-23581568-13" type="text/javascript"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.3.0/sdk.js"></script>
    <style>
        img {
            max-width: 50%;
            height: auto;
        }

        .hidden {
            display: none;
        }


        /* Reset Select */

        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            -ms-appearance: none;
            appearance: none;
            outline: 0;
            box-shadow: none;
            border: 0 !important;
            background: #2c3e50;
            background-image: none;
        }


        /* Remove IE arrow */

        select::-ms-expand {
            display: none;
        }


        /* Custom Select */

        .select {
            position: relative;
            display: flex;
            width: 100%;
            height: 2em;
            line-height: 2;
            background: #2c3e50;
            overflow: hidden;
            border-radius: .25em;
        }

        select {
            flex: 1;
            padding: 0 .5em;
            color: #fff;
            cursor: pointer;
        }


        /* Arrow */

        .select::after {
            content: '\25BC';
            position: absolute;
            top: 0;
            right: 0;
            padding: 0 1em;
            background: #34495e;
            cursor: pointer;
            pointer-events: none;
            -webkit-transition: .25s all ease;
            -o-transition: .25s all ease;
            transition: .25s all ease;
        }


        /* Transition */

        .select:hover::after {
            color: #f39c12;
        }

        input {
            background-color: #e0e0e026;
        }

        #loader {
            position: absolute;
            left: 50%;
            top: 80%;
            z-index: 1;
            margin: -75px 0 0 -75px;
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-bottom: 16px solid #3498db;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 180px;
            height: 180px;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }

        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
            }
            100% {
                -webkit-transform: rotate(360deg);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        #myModal {

            top: 80%;
        }
    </style>

</head>

<body>
    <div class="limiter">
        <div class="container-login100">
            <div class="wrap-login100 p-l-35 p-r-35 p-t-35 p-b-35" style="width: 500px;">
                <div class="container">
                    <!-- Trigger the modal with a button
						<button type="button" onclick="timeclosemodal()" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal">Open Modal</button>
					-->
                    <!-- Modal -->
                    <div class="modal fade" id="myModal" role="dialog">
                        <div class="modal-dialog">
                            <!-- Modal content-->
                            <div class="modal-content">
                                <div class="modal-body">
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                    <p>"請耐心等待，上傳照片視窗會自動關閉。"</p>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="login100-form validate-form">
                    <span class="login100-form-title p-b-33">任務回報</span>
                    <div class="container-fluid">
                        <div class="row" style="margin-bottom:15px;">
                            <div class="col-md-4">依據</div>
                            <div class="col-md-6">
                                <div class="col-md-6" style="padding-right: 0px;padding-left: 0px;">
                                    <input class="input" id="input_base" type="text" name="input" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="margin-bottom:15px;">
                            <div class="col-md-4">任務需求</div>
                            <div class="col-md-6">
                                <div class="col-md-6" style="padding-right: 0px; padding-left: 0px;">
                                    <input class="input" id="input_mission_location" type="text" name="input" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="margin-bottom:15px;">
                            <div class="col-md-4">需求數量(輛)</div>
                            <div class="col-md-6">
                                <div class="col-md-6" style="padding-right: 0px; padding-left: 0px;">
                                    <input class="input" id="input_num" type="text" name="input" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="margin-bottom:15px;">
                            <div class="col-md-4">補充說明</div>
                            <div class="col-md-6">
                                <div class="col-md-6" style="padding-right: 0px; padding-left: 0px;">
                                    <textarea id="input_remarks" rows="5" cols="30" disabled></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="margin-bottom:15px;">
                            <div class="col-md-4">派遣抽水車</div>
                            <div id="car_list" class="col-md-6">
                                <!-- <input type="checkbox" id="vehicle1" name="vehicle1" value="二河-01">
                              <label for="vehicle1">二河-01</label><br>
                              <input type="checkbox" id="vehicle2" name="vehicle2" value="二河-02">
                              <label for="vehicle2">二河-02</label><br>
                              <input type="checkbox" id="vehicle3" name="vehicle3" value="二河-03">
                              <label for="vehicle3">二河-03</label><br>
                              <input type="checkbox" id="vehicle4" name="vehicle4" value="二河-04">
                              <label for="vehicle4">二河-04</label><br>  -->
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">現場狀況</div>
                            <div class="col-md-6 select" style="margin-bottom:15px;">
                                <select name="slct" id="status_select">
                              <option selected="" disabled="">選擇現場狀況</option>
                              <option value="1">待命中</option>
                              <option value="2">運送中</option>
                              <option value="3">抽水中</option>
                              <option value="4">離線</option>
                           </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">淹水深度(公分)</div>
                            <div class="col-md-6 select" style="margin-bottom:15px;">
                                <select name="slct" id="deep_select">
                              <option selected="" disabled="">選擇淹水深度(cm)</option>
                              <option value="&lt;30">&lt;30</option>
                              <option value="35">35</option>
                              <option value="40">40</option>
                              <option value="45">45</option>
                              <option value="50">50</option>
                              <option value="65">65</option>
                              <option value="70">70</option>
                              <option value="75">75</option>
                              <option value="80">80</option>
                              <option value="&gt;80">&gt;80</option>
                           </select>
                            </div>
                        </div>
                        <div class="row" style="margin-bottom:15px;">
                            <div class="col-md-4">現場照片</div>
                            <div class="col-md-6" style="padding-right: 0px; padding-left: 0px;">
                                <input type="file" accept="image/*" id="btn_upload" onchange="validateImage()">
                                <script type="text/javascript">
                                    function validateImage() {
                                        var formData = new FormData();
                                        var file = document.getElementById("btn_upload").files[0];
                                        formData.append("Filedata", file);
                                        var t = file.type.split('/').pop().toLowerCase();
                                        if (t != "jpeg" && t != "jpg" && t != "png" && t != "bmp" && t != "gif") {
                                            alert('請上傳圖檔格式的檔案!');
                                            document.getElementById("btn_upload").value = '';
                                            return false;
                                        }
                                        // if (file.size > 1024000) {
                                        //     alert('Max Upload size is 1MB only');
                                        //     document.getElementById("img").value = '';
                                        //     return false;
                                        // }
                                        var reader = new FileReader();

                                        reader.onload = function(e) {
                                            $('#image_preview').attr('src', e.target.result)
                                        };
                                        reader.readAsDataURL(file);
                                        return true;
                                    }
                                </script>
                            </div>
                        </div>
                        <div class="row" style="margin-bottom:15px;">
                            <div class="col-md-12" style="width: 100%;">
                                <img id="image_preview" style="display: table; margin: 0 auto; width: 80%; height: auto; max-height: 500px;">
                            </div>
                        </div>
                        <div class="container-login100-form-btn m-t-20">
                            <button class="login100-form-btn" id="signUp">回報</button>
                        </div>
                        <!-- LIFF INIT ERROR -->
                        <div id="liffInitErrorMessage" class="hidden">
                            <p>Something went wrong with LIFF initialization.</p>
                            <p>LIFF initialization can fail if a user clicks "Cancel" on the "Grant permission" screen, or if an error occurs in the process of <code>liff.init()</code>.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- <div id="liffcontext"></div> -->
        <div id="loader" style="display: none;"></div>

    </div>
</body>

<script>
    window.onload = function() {
        var myLiffId = "";
        fetch('/webhooks/getliffid')
            .then(function(reqResponse) {
                return reqResponse.json();
            })
            .then(function(jsonResponse) {
                myLiffId = jsonResponse.id;
                initializeLiffOrDie(myLiffId);
            })
            .catch(function(error) {
                document.getElementById("liffInitErrorMessage").classList.remove('hidden');
            });
        //initializeLiffOrDie(defaultLiffId);
    };

    function initializeLiffOrDie(myLiffId) {
        if (!myLiffId) {
            //document.getElementById("liffAppContent").classList.add('hidden');
            //document.getElementById("liffIdErrorMessage").classList.remove('hidden');
            console.log('liffIdErrorMessage');
        } else {
            initializeLiff(myLiffId);
        }
    }
    /**
     * Initialize LIFF
     * @param {string} myLiffId The LIFF ID of the selected element
     */
    function initializeLiff(myLiffId) {
        liff
            .init({
                liffId: myLiffId
            })
            .then(() => {
                // start to use LIFF's api
                initializeApp(myLiffId);
            })
            .catch((err) => {
                //document.getElementById("liffAppContent").classList.add('hidden');
                document.getElementById("liffInitErrorMessage").classList.remove('hidden');
            });
    }

    function initializeApp(myLiffId) {
        const context = liff.getContext();
        //console.log(context);
        //document.getElementById("liffcontext").textContent = liff.getContext().userId;
        $("#signUp").on('click', function(e) {
            if (checkVaildate()) {
                timeclosemodal();
                var pump_car_list = '';
                var contextUserId = context.userId
                if (contextUserId == undefined) {
                    contextUserId = '';
                }
                let checkbox = document.getElementsByName('checkbox');
                checkbox.forEach((element) => {
                    if (element.checked == true) {
                        if (pump_car_list != '') {
                            pump_car_list += ',' + element.value;
                        } else {
                            pump_car_list += element.value;
                        }
                    }
                })
                var selector = document.getElementById('status_select');
                let site_condition = selector.options[selector.selectedIndex].text;
                selector = document.getElementById('deep_select');
                let flood_deep = selector.options[selector.selectedIndex].text;

                var formData = new FormData();
                document.getElementById("loader").style.display = "block";
                var file = document.getElementById("btn_upload").files[0];
                var extension = file.name.split('.').pop();
                formData.append("Filedata", file);
                if (extension == undefined) {
                    extension = '';
                }
                $.ajax({
                    url: "/webhooks/uploadimage?mission_id=" + missionID,
                    data: formData,
                    type: "Post",

                    cache: false, //上傳文件無需緩存
                    processData: false, //用於對data參數進行序列化處理 這裏必須false
                    contentType: false, //必須
                    success: function(result) {
                        document.getElementById("loader").style.display = "none";
                        //alert("上傳完成!");
                        if (liff.isInClient()) {
                            liff.closeWindow();

                        } else {
                            //window.location.href = "about:blank";
                            //window.close();
                        }

                    },
                    error: function(xmlrequest, textStatus, errorThrown) {
                        alert("上傳失敗!");
                        //alert("error:" + textStatus + errorThrown + ":" + JSON.stringify(xmlrequest));
                        console.log("error:" + textStatus + errorThrown + ":" + JSON.stringify(xmlrequest));
                        //document.getElementById("liffcontext").textContent = JSON.stringify(xmlrequest);

                    }
                });
                $.post('/webhooks/querymission', {
                        mission_id: missionID,
                        site_condition: site_condition,
                        flood_deep: flood_deep,
                        site_pic_url: "",
                        pump_car_list: pump_car_list,
                        line_id: contextUserId,
                        ext: extension,
                    },
                    function(data, status) {
                        $('#myModal').modal('show');

                        if (data == '派遣任務回報成功!') {
                            //alert(data);
                            //window.location.href = './login';
                        } else {
                            //alert(data);
                        }
                        //alert("請耐心等待，上傳照片視窗會自動關閉。");
                    });
            } else {
                alert('請檢查是否填妥資訊!');
            }
        });

        function checkVaildate() {
            var result = true;
            let elements = document.getElementsByName('input');
            elements.forEach((element) => {
                if (element.value == '') {
                    result = false;
                }
            })
            let selector = document.getElementsByName('slct');
            selector.forEach((element) => {
                if (element.selectedIndex == 0) {
                    result = false;
                }
            })
            let checkbox = document.getElementsByName('checkbox');
            var checkboxResult = false;
            var breakFlag = false;
            checkbox.forEach((element) => {
                if (breakFlag == false) {
                    if (element.checked == true) {
                        checkboxResult = true;
                        breakFlag = true;
                    } else {
                        checkboxResult = false;
                    }
                }
            })
            if (checkboxResult == false) {
                result = false;
            }
            if (document.getElementById("btn_upload").files.length == 0) {
                result = false;
            }
            return result;
        }

        function hide_modal() {
            $('#myModal').modal('hide');
        }

        function timeclosemodal() {
            window.setTimeout(hide_modal, 3000);
        }
    }
</script>

</html>